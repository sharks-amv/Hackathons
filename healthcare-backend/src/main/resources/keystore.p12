#!/bin/bash

# generate-keystore.sh
# Script to generate SSL keystore for development

echo "🔐 Generating SSL keystore for Healthcare Backend..."

# Configuration
KEYSTORE_FILE="src/main/resources/keystore.p12"
KEYSTORE_PASSWORD="healthcare123"
KEY_ALIAS="healthcare-api"
VALIDITY_DAYS=365
KEY_SIZE=2048

# Certificate details
COMMON_NAME="localhost"
ORGANIZATIONAL_UNIT="Healthcare IT"
ORGANIZATION="Healthcare Management System"
LOCALITY="City"
STATE="State"
COUNTRY="US"

# Distinguished Name
DN="CN=${COMMON_NAME}, OU=${ORGANIZATIONAL_UNIT}, O=${ORGANIZATION}, L=${LOCALITY}, ST=${STATE}, C=${COUNTRY}"

echo "📋 Certificate Details:"
echo "   Common Name: ${COMMON_NAME}"
echo "   Organization: ${ORGANIZATION}"
echo "   Validity: ${VALIDITY_DAYS} days"
echo "   Key Size: ${KEY_SIZE} bits"
echo ""

# Create directory if it doesn't exist
mkdir -p "src/main/resources"

# Generate the keystore
echo "🔑 Generating keystore..."
keytool -genkeypair \
    -alias "${KEY_ALIAS}" \
    -keyalg RSA \
    -keysize ${KEY_SIZE} \
    -storetype PKCS12 \
    -keystore "${KEYSTORE_FILE}" \
    -storepass "${KEYSTORE_PASSWORD}" \
    -keypass "${KEYSTORE_PASSWORD}" \
    -validity ${VALIDITY_DAYS} \
    -dname "${DN}" \
    -ext SAN=dns:localhost,ip:127.0.0.1

if [ $? -eq 0 ]; then
    echo "✅ Keystore generated successfully!"
    echo ""
    echo "📄 Keystore Information:"
    keytool -list -v -keystore "${KEYSTORE_FILE}" -storepass "${KEYSTORE_PASSWORD}" -alias "${KEY_ALIAS}"
    echo ""
    echo "🔧 Configuration for application.yml:"
    echo "server:"
    echo "  ssl:"
    echo "    enabled: true"
    echo "    key-store: classpath:keystore.p12"
    echo "    key-store-password: ${KEYSTORE_PASSWORD}"
    echo "    key-store-type: PKCS12"
    echo "    key-alias: ${KEY_ALIAS}"
    echo ""
    echo "⚠️  IMPORTANT: Change the keystore password in production!"
    echo "⚠️  Add keystore.p12 to .gitignore to avoid committing sensitive files"
else
    echo "❌ Failed to generate keystore"
    exit 1
fi

# Create .gitignore entry if it doesn't exist
if [ ! -f ".gitignore" ]; then
    touch .gitignore
fi

# Add keystore to .gitignore if not already present
if ! grep -q "keystore.p12" .gitignore; then
    echo "# SSL Keystore" >> .gitignore
    echo "*.p12" >> .gitignore
    echo "*.jks" >> .gitignore
    echo "Added keystore files to .gitignore"
fi

echo ""
echo "🚀 You can now run the application with HTTPS support!"
echo "   Access URL: https://localhost:8443"